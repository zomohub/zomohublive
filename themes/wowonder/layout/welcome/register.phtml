<?php
$fields = Wo_GetWelcomeFileds();

// Function to combine and validate the date of birth
function combineDateOfBirth($day, $month, $year) {
    if (checkdate($month, $day, $year)) {
        return $year . '-' . $month . '-' . $day;  // Format as YYYY-MM-DD
    } else {
        return null;  // Return null if the date is invalid
    }
}

// Save the date of birth to the database when the form is submitted
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $day = $_POST['day'];
    $month = $_POST['month'];
    $year = $_POST['year'];
    
    $date_of_birth = combineDateOfBirth($day, $month, $year);

    // Now save the $date_of_birth along with other form data to the database
    // Example:
    // SaveUserData($first_name, $last_name, $email, $gender, $date_of_birth, ...);
}
?>
<div class="wrapper">
    <div class="login">
        <div class="login_left_combo_parent">
            <div class="login_left_combo">
                <a href="<?php echo $wo['config']['site_url'];?>" class="logo"><img src="<?php echo $wo['config']['theme_url'];?>/img/welcome-logo.png" alt="Logo"> </a>
                <h1><?php echo $wo['lang']['connect_with_friends']?></h1>
                <p><?php echo $wo['lang']['welcome_share_text']?></p>
                <div class="fadeInUp animated animated_6 img">
                    <video width="100%" autoplay muted loop>
                    <source src="<?php echo $wo['config']['theme_url'];?>/zomohub.mp4" type="video/mp4">
                    Your browser does not support the video tag.
                    </video>
                </div>
            </div>
            <svg xmlns="http://www.w3.org/2000/svg" width="793" height="1024" viewBox="0 0 793 1024" preserveAspectRatio="none"> <defs> <linearGradient id="linear-gradient" x1="0.066" y1="0.066" x2="1.068" y2="1.075" gradientUnits="objectBoundingBox"> <stop offset="0"/> <stop offset="1" stop-color="<?php echo $wo['config']['btn_background_color'];?>"/> </linearGradient> <clipPath id="clip-path"> <rect id="Rectangle_9" data-name="Rectangle 9" width="793" height="1024" fill="#fff"/> </clipPath> <filter id="Path_12714" x="-258.718" y="668.282" width="1450.299" height="710.185" filterUnits="userSpaceOnUse"> <feOffset dy="13" input="SourceAlpha"/> <feGaussianBlur stdDeviation="15.5" result="blur"/> <feFlood flood-opacity="0.161"/> <feComposite operator="in" in2="blur"/> <feComposite in="SourceGraphic"/> </filter> <filter id="Path_12715" x="-105.819" y="797.563" width="1134.181" height="538.486" filterUnits="userSpaceOnUse"> <feOffset dy="15" input="SourceAlpha"/> <feGaussianBlur stdDeviation="17" result="blur-2"/> <feFlood flood-opacity="0.349"/> <feComposite operator="in" in2="blur-2"/> <feComposite in="SourceGraphic"/> </filter> </defs> <g id="Rectangle_8" data-name="Rectangle 8" stroke="<?php echo $wo['config']['btn_background_color'];?>" stroke-width="1" fill="url(#linear-gradient)" style="mix-blend-mode: multiply;isolation: isolate"> <rect width="793" height="1024" stroke="none"/> <rect x="0.5" y="0.5" width="792" height="1023" fill="none"/> </g> <g id="Mask_Group_4" data-name="Mask Group 4" clip-path="url(#clip-path)"> <g id="Group_13906" data-name="Group 13906" transform="translate(1227.782 1153.043) rotate(180)" opacity="0.54"> <path id="Path_12713" data-name="Path 12713" d="M-5894.321-7099.4s163.513,301.819,384.911,412.243,267.171-29.452,500.682,29.452,205.095,175.206,371.288,195.191,226.553,0,293.483-144.4-39.545-197.743-39.545-346.053,39.545-218.046,39.545-218.046Z" transform="translate(5874.603 7034.028)" fill="<?php echo $wo['config']['btn_background_color'];?>" opacity="0.68"/> <g transform="matrix(-1, 0, 0, -1, 1227.78, 1153.04)" filter="url(#Path_12714)"> <path id="Path_12714-2" data-name="Path 12714" d="M-5894.321-7109.194s141.139,260.521,332.244,355.836,230.614-25.422,432.174,25.422,177.032,151.232,320.484,168.483,195.554,0,253.326-124.639-34.134-170.686-34.134-298.7,34.134-188.211,34.134-188.211Z" transform="translate(-4749.24 -5852.04) rotate(180)" fill="<?php echo $wo['config']['btn_background_color'];?>" opacity="0.46"/> </g> <g transform="matrix(-1, 0, 0, -1, 1227.78, 1153.04)" filter="url(#Path_12715)"> <path id="Path_12715-2" data-name="Path 12715" d="M-5894.321-7124s107.332,198.118,252.66,270.6,204.216-38.665,357.5,0,183.031,93.193,210.813,104.632,152.776,42.826,196.709-51.958-25.958-129.8-25.958-227.154,25.958-143.128,25.958-143.128Z" transform="translate(-4916.96 -5900.96) rotate(180)" fill="<?php echo $wo['config']['btn_background_color'];?>" opacity="0.77"/> </g> </g> </g> </svg>
        </div>
        <div class="col-md-6">
            <div class="login_innre row">
            <form id="register" class="" method="post">
                <p class="title main"><?php echo $wo['lang']['register']?></p>
                <p class="desc"><?php echo str_replace(array('{site_name}', '{Site_Name}', '{sito_name}'), array($wo['config']['siteName'], $wo['config']['siteName'], $wo['config']['siteName']), $wo['lang']['register_create_account'])?></p>
                <div class="alert alert-danger errors"></div>
                <?php if ($wo['config']['auto_username'] == 1) { ?>
                    <div class="wow_form_fields col-md-6">
                        <input id="first_name" name="first_name" type="text" placeholder="<?php echo $wo['lang']['first_name']?>" autocomplete="off" autofocus>
                    </div>
                    <div class="wow_form_fields col-md-6">
                        <input id="last_name" name="last_name" type="text" placeholder="<?php echo $wo['lang']['last_name']?>" autocomplete="off">
                    </div>
                <?php }else{ ?>
                    <div class="wow_form_fields col-md-12">
                        <input id="username" name="username" type="text" placeholder="<?php echo $wo['lang']['username']?>" autocomplete="off" autofocus>
                    </div>
                <?php } ?>
                <div class="wow_form_fields col-md-6">
                    <input id="email" name="email" placeholder="<?php echo $wo['lang']['email_address']?>" type="email" />
                </div>
                <div class="wow_form_fields col-md-6">
                    <select name="gender" id="gender">
                        <option value="0"><?php echo $wo['lang']['gender']?></option>
                        <?php foreach ($wo['genders'] as $key => $gender) { ?>
                            <option value="<?php echo($key) ?>"><?php echo $gender; ?></option>
                        <?php } ?>
                    </select>
                </div>
                <?php if($wo['config']['sms_or_email'] == 'sms') {?>
                    <div class="wow_form_fields  col-md-12">
                        <label for="phone_num_ex"><?php echo $wo['lang']['phone_num_ex']?></label>
                        <input id="phone_num_ex" name="phone_num" type="text" />
                    </div>
                <?php } ?>
                <div class="wow_form_fields  col-md-6">
                    <input id="password" name="password" placeholder="<?php echo $wo['lang']['password']?>" type="password" />
                    <?php if ($wo['config']['password_complexity_system'] == 1) { ?>
                        <ul class="list-unstyled helper-text">
                            <li class="length"><?php echo $wo['lang']['least_characters']; ?></li>
                            <li class="lowercase"><?php echo $wo['lang']['contain_lowercase']; ?></li>
                            <li class="uppercase"><?php echo $wo['lang']['contain_uppercase']; ?></li>
                            <li class="special"><?php echo $wo['lang']['number_special']; ?></li>
                        </ul>
                    <?php } ?>
                </div>
                <div class="wow_form_fields  col-md-6">
                    <input id="confirm_password" name="confirm_password" placeholder="<?php echo $wo['lang']['confirm_password']?>" type="password" />
                </div>
                <?php
                    if (!empty($fields) && count($fields) > 0) {
                        foreach ($fields as $key => $wo['field']) {
                            echo Wo_LoadPage('welcome/fields');
                        }
                    }
                ?>
                <div class="wow_form_fields col-md-12">
                        <label for="day">Date of birth</label>
                </div>
                <div class="wow_form_fields col-md-4" style="padding-left:15px">    
                    <select name="day" id="day">
                    <option value="01">1</option>
                    <option value="02">2</option>
                    <option value="03">3</option>
                    <option value="04">4</option>
                    <option value="05">5</option>
                    <option value="06">6</option>
                    <option value="07">7</option>
                    <option value="08">8</option>
                    <option value="09">9</option>
                    <option value="10">10</option>
                    <option value="11">11</option>
                    <option value="12">12</option>
                    <option value="13">13</option>
                    <option value="14">14</option>
                    <option value="15">15</option>
                    <option value="16">16</option>
                    <option value="17">17</option>
                    <option value="18">18</option>
                    <option value="19">19</option>
                    <option value="20">20</option>
                    <option value="21">21</option>
                    <option value="22">22</option>
                    <option value="23">23</option>
                    <option value="24">24</option>
                    <option value="25">25</option>
                    <option value="26">26</option>
                    <option value="27">27</option>
                    <option value="28">28</option>
                    <option value="29">29</option>
                    <option value="30">30</option>
                    <option value="31">31</option>
                    </select>
                </div>
                <div class="wow_form_fields col-md-4" style="padding-left:auto">
                    <select name="month">
                    <option value="01">Jan</option>
                    <option value="02">Feb</option>
                    <option value="03">Mar</option>
                    <option value="04">Apr</option>
                    <option value="05">May</option>
                    <option value="06">June</option>
                    <option value="07">July</option>
                    <option value="08">Aug</option>
                    <option value="09">Sep</option>
                    <option value="10">Oct</option>
                    <option value="11">Nov</option>
                    <option value="12">Dec</option>
                    </select>
                </div>
                <div class="wow_form_fields col-md-4" style="padding-left:auto">
                    <?php 
                    $currentYear = date('Y');
                    $startYear = $currentYear - 10;
                    $endYear = $currentYear - 100;
                    ?>
                    <select name="year">
                        <?php
                            for ($year = $startYear; $year >= $endYear; $year--) {
                                echo "<option value=\"$year\">$year</option>";
                            }
                        ?>
                    </select>
                </div>
                
                <?php if($wo['config']['reCaptcha'] == 1) {?>
                    <div class="form-group" style="margin-top:10px;">
                        <div class="g-recaptcha" data-sitekey="<?php echo $wo['config']['reCaptchaKey']?>"></div>
                    </div>
                <?php } ?>
                <?php if(!empty( $_GET['last_url'])){?>
                    <div class="form-group">
                        <input type="hidden" name="last_url" value="<?php echo urldecode(Wo_Secure($_GET['last_url']));?>">
                    </div>
                <?php } ?>
                <div class="terms col-md-12">
                    <input type="checkbox" name="accept_terms" id="accept_terms" onchange="activateButton(this)">
                    <label for="accept_terms">
                        <?php echo $wo['lang']['terms_agreement'] ?> <a target="_blank" href="<?php echo Wo_SeoLink('index.php?link1=terms&type=terms');?>" class="main"><?php echo $wo['lang']['terms_of_use'] ?></a> & <a target="_blank" href="<?php echo Wo_SeoLink('index.php?link1=terms&type=privacy-policy');?>" class="main"><?php echo $wo['lang']['privacy_policy'] ?></a>
                    </label>
                    <div class="clear"></div>
                </div>
                <div class="login_signup_combo col-md-12">
                    <div class="login__">
                        <button type="submit" class="btn btn-main btn-mat add_wow_loader" id="sign_submit" disabled><?php echo $wo['lang']['lets_go']?></button>
                    </div>
                    <div class="signup__">
                        <p><?php echo $wo['lang']['already_have_account']?> <a class="dec main" href="<?php echo $wo['config']['site_url'];?>"><?php echo $wo['lang']['login']?></a></p>
                    </div>
                </div>
                <?php
                 if (isset($_GET['invite']) && (Wo_IsAdminInvitationExists($_GET['invite']) || Wo_IsUserInvitationExists($_GET['invite']))): ?>
                    <input type="text" class="hidden" value="<?php echo $_GET['invite']; ?>" name="invited">
                <?php endif; ?>
                 <!-- Resend Email and Retry buttons -->
                 <div id="resend_email_section" style="display: none; text-align: center; margin-top: 20px;">
                        <button type="button" id="resend_email_btn" class="btn btn-secondary">Resend Email</button>
                        <button type="button" id="retry_btn" class="btn btn-secondary">Retry Registration</button>
                    </div>
            </form>
            </div>
            <div class="footer">
                <?php echo Wo_LoadPage('footer/welcome');?>
                <div class="clearfix"></div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var working = false;
    var $this = $('#register');
    var $state = $this.find('.errors');
    var $resendEmailSection = $('#resend_email_section');
    var $resendEmailBtn = $('#resend_email_btn');
    var $retryBtn = $('#retry_btn');

    // Function to enable or disable the submit button
    function activateButton(element) {
        if (element.checked) {
            document.getElementById("sign_submit").disabled = false;
        } else {
            document.getElementById("sign_submit").disabled = true;
        }
    }

    // Bind event to the checkbox for activating the submit button
    $('#accept_terms').on('change', function() {
        activateButton(this);
    });
    
    // Ensure the button is enabled if the checkbox is already checked on page load
    if ($('#accept_terms').is(':checked')) {
        $('#sign_submit').prop('disabled', false);
    }

    // Form submission logic
    $this.ajaxForm({
        url: Wo_Ajax_Requests_File() + '?f=register',
        beforeSend: function() {
            <?php if ($wo['config']['password_complexity_system'] == 1) { ?>
            if ($('.helper-text .length').hasClass('valid') && $('.helper-text .lowercase').hasClass('valid') && $('.helper-text .uppercase').hasClass('valid') && $('.helper-text .special').hasClass('valid')) {
                working = true;
                $this.find('button').attr("disabled", true);
                $this.find('.add_wow_loader').addClass('btn-loading');
            } else {
                $state.html("<?php echo($wo['lang']['complexity_requirements']) ?>");
                return false;
            }
            <?php } else { ?>
            working = true;
            $this.find('button').attr("disabled", true);
            $this.find('.add_wow_loader').addClass('btn-loading');
            <?php } ?>
        },
        success: function(data) {
            if (data.status == 200) {
                $state.removeClass('alert-danger').addClass('alert-success').html('<?php echo $wo['lang']['welcome_'] ?>');
                $this.find('.add_wow_loader').removeClass('btn-loading');
                $this.find('.wow_form_fields, .terms, .login_signup_combo').hide();

                // Show resend email and retry options
                $resendEmailSection.show();

                
            } else if (data.status == 300) {
                window.location.href = data.location;
            }else if (data.status == 202) {
                // Registration successful but requires email verification
                $state.removeClass('alert-danger').addClass('alert-success').html(data.message);
                $this.find('.wow_form_fields, .terms, .login_signup_combo').hide();  // Hide form
                $this.find('button').attr("disabled", false);
                $resendEmailSection.show();
            }else {
                $this.find('button').attr("disabled", false);
                $this.find('.add_wow_loader').removeClass('btn-loading');
                $state.html(data.errors);
            }
            working = false;
        }
    });
    $(document).ready(function() {
            $resendEmailBtn.on('click', function() {
            console.log('Resend Email button clicked'); // Add this line for debugging
            var email = $('#email').val();
            $.ajax({
                type: 'POST',
                url: Wo_Ajax_Requests_File() + '?f=resend_email',
                data: { email: email },
                beforeSend: function() {
                    $resendEmailBtn.text('Resending...');
                },
                success: function(response) {
                    if (response.status === 200) {
                        $state.removeClass('alert-danger').addClass('alert-success').text(response.message);
                        $resendEmailBtn.text('Email Resent Successfully');
                    } else {
                        $state.removeClass('alert-success').addClass('alert-danger').text(response.errors);
                        $resendEmailBtn.text('Resend Email');
                    }
                }
            });
        });

        $retryBtn.on('click', function() {
            // Reset form fields
            $this.trigger('reset');

            // Clear any error or success messages
            $state.empty().removeClass('alert-danger alert-success');

            // Hide resend email section
            $resendEmailSection.hide();

            // Show form fields and terms again
            $this.find('.wow_form_fields, .terms, .login_signup_combo').show();

            // Reset the "Let's Go" button
            $this.find('button').prop('disabled', true).removeClass('btn-loading');
        });

    });

    <?php if ($wo['config']['password_complexity_system'] == 1) { ?>
    (function(){
        var helperText = {
            charLength: document.querySelector('.helper-text .length'),
            lowercase: document.querySelector('.helper-text .lowercase'),
            uppercase: document.querySelector('.helper-text .uppercase'),
            special: document.querySelector('.helper-text .special')
        };
        var password = document.querySelector('#password');

        var pattern = {
            charLength: function() {
                return password.value.length >= 6;
            },
            lowercase: function() {
                return /^(?=.*[a-z]).+$/.test(password.value);
            },
            uppercase: function() {
                return /^(?=.*[A-Z]).+$/.test(password.value);
            },
            special: function() {
                return /^(?=.*[0-9_\W]).+$/.test(password.value);
            }
        };

        password.addEventListener('keyup', checkPassword);
        password.addEventListener('input', checkPassword);

        function checkPassword() {
            $('.helper-text').slideDown('slow');
            patternTest(pattern.charLength(), helperText.charLength);
            patternTest(pattern.lowercase(), helperText.lowercase);
            patternTest(pattern.uppercase(), helperText.uppercase);
            patternTest(pattern.special(), helperText.special);

            if (isValidPassword()) {
                addClass(password.parentElement, 'valid');
            } else {
                removeClass(password.parentElement, 'valid');
            }
        }

        function patternTest(pattern, response) {
            pattern ? addClass(response, 'valid') : removeClass(response, 'valid');
        }

        function addClass(el, className) {
            el.classList ? el.classList.add(className) : el.className += ' ' + className;
        }

        function removeClass(el, className) {
            el.classList ? el.classList.remove(className) : el.className = el.className.replace(new RegExp('(^|\\b)' + className.split(' ').join('|') + '(\\b|$)', 'gi'), ' ');
        }

        function isValidPassword() {
            return hasClass(helperText.charLength, 'valid') &&
                   hasClass(helperText.lowercase, 'valid') &&
                   hasClass(helperText.uppercase, 'valid') &&
                   hasClass(helperText.special, 'valid');
        }

        function hasClass(el, className) {
            return el.classList ? el.classList.contains(className) : new RegExp('(^| )' + className + '( |$)', 'gi').test(el.className);
        }
    })();
    <?php } ?>
});
</script>
